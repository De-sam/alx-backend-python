#!/bin/bash

# Define deployment and service names
BLUE_DEPLOYMENT="django-app-blue-deployment"
GREEN_DEPLOYMENT="django-app-green-deployment"
APP_SERVICE="django-app-service"

# Step 1: Deploy the current (blue) version of the app and the service
echo "Deploying the current (blue) version of the app..."
kubectl apply -f blue_deployment.yaml
kubectl apply -f kubeservice.yaml

echo "Blue version deployed and service configured."
echo "------------------------------------------------"

# Step 2: Deploy the new (green) version of the app
echo "Deploying the new (green) version for testing..."
kubectl apply -f green_deployment.yaml

echo "Green version deployed. Waiting for pod to become ready..."
sleep 15 # Wait for the new Pod to start

# Step 3: Check for errors in the new (green) version
echo "Checking logs for the new (green) version..."
GREEN_POD_NAME=$(kubectl get pods -l app=django-messaging-app,version=green -o jsonpath="{.items[0].metadata.name}")
kubectl logs "$GREEN_POD_NAME"

echo "------------------------------------------------"
echo "Deployment complete. The 'blue' version is still serving live traffic."
echo "After you've verified the 'green' version is healthy, you can perform the switchover by editing 'kubeservice.yaml' and changing 'version: blue' to 'version: green' and running 'kubectl apply -f kubeservice.yaml' again."